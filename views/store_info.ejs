<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= storename %> | DinesNDash</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script>
      const TRENDING_DATA = <%- JSON.stringify(Trending) %>;
      const DEALS_DATA = <%- JSON.stringify(Deals) %>;
      const CATEGORY_DATA = <%- JSON.stringify(Categories) %>;
      const MEALS_DATA = [...TRENDING_DATA, ...DEALS_DATA];
      const storename=<%- JSON.stringify(storename) -%>;
      const USER = <%- JSON.stringify(user) %>;
    </script>

    <style>
      :root {
        --primary: #e11d48;
        --primary-hover: #be123c;
        --primary-light: #fff1f2;
        --dark: #0f172a;
        --gray: #64748b;
        --light-gray: #f1f5f9;
        --white: #ffffff;
        --border: #e2e8f0;
        --radius-lg: 1.25rem;
        --radius-md: 0.75rem;
        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: var(--light-gray);
        color: var(--dark);
        display: flex;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        width: 280px;
        background: var(--white);
        height: 100vh;
        position: fixed;
        padding: 2rem;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        z-index: 100;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 2.5rem;
        color: var(--dark);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo span {
        color: var(--primary);
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        text-decoration: none;
        color: var(--gray);
        font-weight: 600;
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        transition: 0.3s;
      }
      .nav-link.active,
      .nav-link:hover {
        background: var(--primary-light);
        color: var(--primary);
      }

      /* --- MAIN CONTENT --- */
      .main-content {
        margin-left: 280px;
        flex: 1;
        padding: 2rem;
        min-height: 100vh;
      }

      /* --- POWERFUL SEARCH BAR --- */
      .top-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        position: sticky;
        top: 0;
        z-index: 90;
        background: var(--light-gray);
        padding: 10px 0;
      }

      .search-container {
        position: relative;
        width: 100%;
        max-width: 500px;
      }

      .search-container i {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
      }

      #mainSearch {
        width: 100%;
        padding: 14px 14px 14px 50px;
        border-radius: var(--radius-lg);
        border: 2px solid transparent;
        background: var(--white);
        box-shadow: var(--shadow);
        font-size: 1rem;
        transition: 0.3s;
      }

      #mainSearch:focus {
        border-color: var(--primary);
        outline: none;
      }

      /* --- SECTION STYLING --- */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 1.5rem;
        margin-top: 2rem;
      }

      .section-header h3 {
        font-weight: 800;
        font-size: 1.25rem;
      }
      .section-header a {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
      }

      /* Horizontal Scroller */
      .horizontal-scroll {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 15px;
        scrollbar-width: none;
      }
      .horizontal-scroll::-webkit-scrollbar {
        display: none;
      }

      /* Food Cards */
      .food-card {
        background: var(--white);
        min-width: 240px;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: 0.3s;
        position: relative;
      }
      .food-card:hover {
        transform: translateY(-5px);
      }

      .card-img {
        height: 160px;
        width: 100%;
        object-fit: cover;
      }

      .price-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: var(--white);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 800;
        font-size: 0.9rem;
        color: var(--primary);
      }

      .card-body {
        padding: 1.25rem;
      }
      .meal-title {
        font-weight: 700;
        margin-bottom: 5px;
      }
      .store-sub {
        font-size: 0.8rem;
        color: var(--gray);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .add-btn {
        width: 100%;
        margin-top: 15px;
        padding: 10px;
        border: none;
        background: var(--dark);
        color: white;
        border-radius: var(--radius-md);
        font-weight: 700;
        cursor: pointer;
        transition: 0.3s;
      }
      .add-btn:hover {
        background: var(--primary);
      }

      /* --- CART SIDEBAR (DRAWER) --- */
      .cart-drawer {
        position: fixed;
        right: -400px;
        top: 0;
        width: 380px;
        height: 100vh;
        background: var(--white);
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 200;
        display: flex;
        flex-direction: column;
        padding: 2rem;
      }
      .cart-drawer.open {
        right: 0;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        z-index: 190;
      }
      .overlay.open {
        display: block;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          display: none;
        }
        .main-content {
          margin-left: 0;
        }
      }
      .category-grid {
        display: flex;
        gap: 25px;
        overflow-x: auto;
        padding: 10px 5px;
        scrollbar-width: none;
      }
      .category-grid::-webkit-scrollbar {
        display: none;
      }

      .category-card {
        min-width: 100px;
        text-align: center;
        text-decoration: none;
        transition: transform 0.3s;
      }
      .category-card:hover {
        transform: scale(1.05);
      }

      .cat-img-wrapper {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: var(--white);
        margin: 0 auto 10px;
        padding: 5px;
        box-shadow: var(--shadow);
        border: 2px solid transparent;
        transition: 0.3s;
      }
      .category-card:hover .cat-img-wrapper {
        border-color: var(--primary);
      }

      .cat-img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      .category-card h5 {
        font-size: 0.8rem;
        color: var(--dark);
        font-weight: 700;
        margin-top: 5px;
      }

      /* Hidden Search Results Section */
      #search-results-section {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="overlay" id="cartOverlay" onclick="toggleCart()"></div>

    <aside class="sidebar">
      <a href="/" class="logo">
        <i class="fa-solid fa-utensils" style="color: var(--primary)"></i>
        <span>Dines<span>N</span>Dash</span>
      </a>
      <nav>
        <a href="/dashboard" class="nav-link active"
          ><i class="fa-solid fa-house"></i> Dashboard</a
        >
        <a href="/fav/meals" class="nav-link"
          ><i class="fa-solid fa-heart"></i> Favorites</a
        >
        <a href="/all/orders/users" class="nav-link"
          ><i class="fa-solid fa-receipt"></i> Orders</a
        >
        <a href="#" class="nav-link"
          ><i class="fa-solid fa-wallet"></i> Wallet</a
        >
      </nav>

      <div
        style="
          margin-top: auto;
          padding-top: 20px;
          border-top: 1px solid var(--border);
        "
      >
        <div style="display: flex; align-items: center; gap: 12px">
          <img
            src="https://ui-avatars.com/api/?name=<%= user.fullname %>"
            style="width: 40px; border-radius: 50%"
          />
          <div>
            <p style="font-weight: 700; font-size: 0.9rem">
              <%= user.fullname %>
            </p>
            <p style="font-size: 0.75rem; color: var(--gray)">Customer</p>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="top-header">
        <div class="search-container">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            type="text"
            id="mainSearch"
            placeholder="Search for meals, deals, or categories..."
            oninput="handleSearch(this.value)"
          />
        </div>

        <button
          onclick="toggleCart()"
          style="
            position: relative;
            background: var(--white);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            box-shadow: var(--shadow);
            cursor: pointer;
          "
        >
          <i class="fa-solid fa-cart-shopping"></i>
          <span
            id="cart-badge"
            style="
              position: absolute;
              top: -5px;
              right: -5px;
              background: var(--primary);
              color: white;
              font-size: 0.7rem;
              padding: 2px 6px;
              border-radius: 10px;
            "
            >0</span
          >
        </button>
      </header>
      <section id="Categories-Section">
        <div class="section-header">
          <h3>Shop By Category</h3>
        </div>
        <div class="category-grid" id="categoryContainer"></div>
      </section>

      <section id="search-results-section">
        <div class="section-header">
          <h3 id="search-title">Search Results</h3>
          <a href="#" onclick="clearSearch()">Clear</a>
        </div>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
          "
          id="searchResultsGrid"
        ></div>
      </section>

      <section id="trending-section">
        <div class="section-header">
          <h3>üî• Trending Now</h3>
          <a href="#">View All</a>
        </div>
        <div class="horizontal-scroll" id="trendingGrid"></div>
      </section>

      <section id="deals-section">
        <div class="section-header">
          <h3>üéÅ Best Deals</h3>
          <a href="#">View All</a>
        </div>
        <div class="horizontal-scroll" id="dealsGrid"></div>
      </section>
    </main>

    <div class="cart-drawer" id="cartDrawer">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
        "
      >
        <h2 style="font-weight: 800">Your Cart</h2>
        <button
          onclick="toggleCart()"
          style="
            border: none;
            background: none;
            font-size: 1.2rem;
            cursor: pointer;
          "
        >
          &times;
        </button>
      </div>
      <div id="cartItems" style="flex: 1; overflow-y: auto"></div>
      <div
        style="
          border-top: 1px solid var(--border);
          padding-top: 1.5rem;
          margin-top: 1rem;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
          "
        >
          <span>Total</span>
          <span
            id="cartTotal"
            style="font-weight: 800; font-size: 1.2rem; color: var(--primary)"
            >R0.00</span
          >
        </div>
        <button
          class="add-btn"
          id="checkout-btn"
          style="padding: 15px; font-size: 1rem"
        >
          Checkout Now
        </button>
      </div>
    </div>

    <script>
      let cart = JSON.parse(localStorage.getItem("Cart")) || [];
      console.log(TRENDING_DATA);

      function init() {
        renderCat(CATEGORY_DATA, "categoryContainer");
        renderSection(TRENDING_DATA, "trendingGrid");
        renderSection(DEALS_DATA, "dealsGrid");
        updateCartUI();
      }

      // --- IMPROVED SEARCH LOGIC ---
      function handleSearch(query) {
        const q = query.toLowerCase();
        const searchResultsSection = document.getElementById(
          "search-results-section"
        );
        const trendingSec = document.getElementById("trending-section");
        const dealsSec = document.getElementById("deals-section");
        const catSec = document.getElementById("Categories-Section");

        if (q.length > 0) {
          // Filter logic
          const filtered = MEALS_DATA.filter(
            (item) =>
              item.meal_name.toLowerCase().includes(q) ||
              (item.description && item.description.toLowerCase().includes(q))
          );

          // UI Toggle
          searchResultsSection.style.display = "block";
          trendingSec.style.display = "none";
          dealsSec.style.display = "none";
          catSec.style.display = "none";

          document.getElementById(
            "search-title"
          ).innerText = `Results for "${query}"`;
          renderSection(filtered, "searchResultsGrid");
        } else {
          clearSearch();
        }
      }

      function clearSearch() {
        document.getElementById("mainSearch").value = "";
        document.getElementById("search-results-section").style.display =
          "none";
        document.getElementById("trending-section").style.display = "block";
        document.getElementById("deals-section").style.display = "block";
        document.getElementById("Categories-Section").style.display = "block";
      }

      // --- FIXED CATEGORY RENDER ---
      function renderCat(data, container_id) {
        const container = document.getElementById(container_id);
        container.innerHTML = "";

        data.forEach((cat) => {
          console.log("This is the cat",cat);
          console.log(cat.used_stock_image);
          let imgSrc=null;
          if(cat.used_stock_image=="YES"){
            imgSrc=`${cat.category_pic}`;
          }else if(cat.used_stock_image=="NO"){
            imgSrc=`/${cat.category_pic}`;
          }
          console.log("This is the imgSrc",imgSrc);
          const card = document.createElement("a");
          card.href = `/category/user/${cat.Cat_id}`;
          card.className = "category-card";
          card.innerHTML = `
            <div class="cat-img-wrapper">
              <img src='${imgSrc}'/>
            </div>
            <h5>${cat.catagory_name}</h5>
          `;
          container.appendChild(card); // Append INSIDE the loop
        });
      }

      function renderSection(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        if (!data || data.length === 0) {
          container.innerHTML = `<p style="color:var(--gray); padding: 20px;">No items found.</p>`;
          return;
        }

        data.forEach((item) => {
          console.log("This is the item", item);
          const img = item.Images
            ? typeof item.Images === "string"
              ? JSON.parse(item.Images)[0]
              : item.Images[0]
            : "placeholder.jpg";

          const card = document.createElement("div");
          card.className = "food-card";
          card.innerHTML = `
                    <div style="position:relative">
                        <img src="/${img}" class="card-img">
                        <div class="price-badge">R${item.SellingPrice}</div>
                    </div>
                    <div class="card-body">
                        <div class="meal-title">${item.meal_name}</div>
                        <div class="store-sub"><i class="fa-solid fa-clock"></i> ${
                          item.TimeTo || 20
                        } min ‚Ä¢ ${storename}</div>
                        <button class="add-btn" onclick="addToCart('${
                          item.meal_id
                        }')">Add to Cart</button>
                    </div>
                `;
          container.appendChild(card);
        });
      }

      // --- CART LOGIC ---
      function addToCart(mealId) {
        const item =
          ALL_MEALS.find((m) => String(m.meal_id) === String(mealId)) ||
          TRENDING_DATA.find((m) => String(m.meal_id) === String(mealId)) ||
          DEALS_DATA.find((m) => String(m.meal_id) === String(mealId));

        if (!item) return;

        const existing = cart.find((c) => String(c.meal_id) === String(mealId));
        if (existing) {
          existing.qty++;
        } else {
          cart.push({ ...item, qty: 1 });
        }

        saveCart();
        updateCartUI();
        toggleCart(true);
      }

      function updateCartUI() {
        const list = document.getElementById("cartItems");
        const totalEl = document.getElementById("cartTotal");
        const badge = document.getElementById("cart-badge");

        let total = 0;
        let count = 0;
        list.innerHTML = "";

        cart.forEach((item) => {
          total += item.SellingPrice * item.qty;
          count += item.qty;
          list.innerHTML += `
                    <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center">
                        <div style="flex:1">
                            <p style="font-weight:700; font-size:0.9rem">${item.meal_name}</p>
                            <p style="color:var(--primary); font-weight:600">R${item.SellingPrice}</p>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px; background:var(--light-gray); padding:5px 10px; border-radius:10px">
                            <button onclick="changeQty('${item.meal_id}', -1)" style="border:none; background:none; cursor:pointer">-</button>
                            <span style="font-weight:700">${item.qty}</span>
                            <button onclick="changeQty('${item.meal_id}', 1)" style="border:none; background:none; cursor:pointer">+</button>
                        </div>
                    </div>
                `;
        });

        badge.innerText = count;
        totalEl.innerText = `R${total.toFixed(2)}`;
      }

      function changeQty(id, delta) {
        const idx = cart.findIndex((c) => String(c.meal_id) === String(id));
        if (idx === -1) return;
        cart[idx].qty += delta;
        if (cart[idx].qty <= 0) cart.splice(idx, 1);
        saveCart();
        updateCartUI();
      }

      function saveCart() {
        localStorage.setItem("Cart", JSON.stringify(cart));
      }

      function toggleCart(open = null) {
        const drawer = document.getElementById("cartDrawer");
        const overlay = document.getElementById("cartOverlay");
        if (open === true) {
          drawer.classList.add("open");
          overlay.classList.add("open");
        } else {
          drawer.classList.toggle("open");
          overlay.classList.toggle("open");
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
